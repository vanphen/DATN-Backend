<div class="contact1-pic js-tilt icon-chat" data-tilt="" style="will-change: transform; transform: perspective(300px) rotateX(0deg) rotateY(0deg);position: absolute;
      bottom: 10px;
      right: 10px;
      width: 10%;
      display:none;
      ">
   <img src="https://lh3.googleusercontent.com/proxy/1O5RSgaZOUQdSdszthNZ3ZzGNCfi73yl1Ykqu86mV7QMSQIoBJK6tkJI6Lq-bXSz8l-5SBoACBtyL7mRyX9c2U4l5DiQBzAMK8pYoRoea4a7jg" alt="IMG">
</div>
<div class='banner-noti-browser'>
   <div class='banner-noti-browser__group'>
      <div class="contact1-pic js-tilt" data-tilt=""
         style="will-change: transform; transform: perspective(300px) rotateX(0deg) rotateY(0deg);">
         <img src="https://lh3.googleusercontent.com/proxy/1O5RSgaZOUQdSdszthNZ3ZzGNCfi73yl1Ykqu86mV7QMSQIoBJK6tkJI6Lq-bXSz8l-5SBoACBtyL7mRyX9c2U4l5DiQBzAMK8pYoRoea4a7jg" alt="IMG">
      </div>
      <span class='banner-noti-browser__title'>Đừng bỏ lỡ những thông tin hữu ích , chúng tôi sẵn sàng phục vụ bạn
         !</span>
   </div>
   <div class='flx flx-al-c banner-noti-browser__group-btn'>
      <button
         class='button button-default button-medium clickable banner-noti-browser__group-btn__turn-on button-chat'><span><a
               style='color:#ffffff'>Chat với tư vấn viên</a></span></button>
      <button class='button button-default button-medium clickable banner-noti-browser__group-btn__cancel'
         id='longanit'><span>Chào tạm biệt</span></button>
   </div>
</div>
<form class="contact1-form  validate-form" style="
      background: linear-gradient(to bottom, rgba(43, 119, 190, 0.94), rgb(74, 121, 206));
      right: 30px;
      border-radius: 13px;
      position: absolute;
      bottom: 40px;
      width: 318px;
      height: 429px;
      display: none
      ">
   <a class="close"><i class="fa fa-times fa-2x"></i></a>
   <span class="contact1-form-title" style="
     color: #ffffff;
     font-size: 30px;
     margin-left: 20px;">
      Thông tin của bạn
   </span>
   <div class="form-chat" style="
         padding-right: 20px;
         padding-left: 20px;
         margin-top: 10px;
         margin-bottom: 10px;
   ">
      <div class="wrap-input1 form-group validate-input " data-validate="Name is required">
         <input class="form-control input1" type="text" required name="name" placeholder="Tên của bạn">
         <span class="shadow-input1"></span>
      </div>
      <div class="wrap-input1 form-group validate-input " data-validate="Valid email is required">
         <input class="form-control input1" type="text" required name="email" placeholder="Tài khoản email">
         <span class="shadow-input1"></span>
      </div>
      <div class="wrap-input1 form-group validate-input " data-validate="Valid phone is required">
         <input class="form-control input1" type="text" required name="phone" placeholder="SĐT (chat online có  thể trống)">
         <span class="shadow-input1"></span>
      </div>
      <div class="wrap-input1 form-group validate-input " data-validate="Valid email is required">
         <textarea  class="form-control input1" name="content" placeholder="Nội dung cần tư vấn (chat online có thể trống)"></textarea>
         <span class="shadow-input1"></span>
      </div>
      <textarea style="display: none;" class="form-control input1" name="message" placeholder="Message">test</textarea>
      </div>
   </div>
   <div class="container-contact1-form-btn">
      <button type="button" class="btn btn-primary contact1-form-btn open-button" style="
     background: #0602ff;
     margin-bottom: 20px;
     margin-left: 18px;
     border-radius: 7px;
            ">
         <span>
            Chat Online
         </span>
      </button>
      <button type="button" class="btn btn-primary contact1-form-btn register-customer" style="
         background: #0602ff;
         margin-bottom: 20px;
         margin-left: 57px;
         border-radius: 7px;
         ">
      <span>
         Đăng kí tư vấn
      </span>
   </button>
   </div>
</form>

<div id="myModal" class="container" style="display: none">
   <div class="card">
      <div class="card-header msg_head">
         <div class="d-flex bd-highlight">
            <div class="img_cont">
               <img src="http://18.178.242.31:8080/logo.png" class="rounded-circle user_img">
               <span class="online_icon"></span>
            </div>
            <div class="user_info">
               <span class="name_customer">chat với nhân viên</span>
            </div>
            <div class="video_cam">
               <span id="myBtn"><i class="fas fa-video"></i></span>
               <span id="close"><i class="fa fa-times"></i></span>
            </div>
         </div>

         <div class="action_menu">
            <ul>
               <li><i class="fas fa-user-circle"></i> View profile</li>
               <li><i class="fas fa-users"></i> Add to close friends</li>
               <li><i class="fas fa-plus"></i> Add to group</li>
               <li><i class="fas fa-ban"></i> Block</li>
            </ul>
         </div>
      </div>
      <div class="card-body msg_card_body">
         <div class="d-flex justify-content-start mb-4">
            <div class="img_cont_msg">
               <img src="http://18.178.242.31:8080/logo.png"
                  class="rounded-circle user_img_msg">
            </div>
            <div class="msg_cotainer">
               Xin chào bạn Chúng tôi Có thể giúp gì cho bạn .
               <span class="msg_time"> Today</span>
            </div>
         </div>
      </div>
      <div class="card-footer">
         <div class="input-group" style="display: flex;">
            <div class="input-group-append">
               <span class="input-group-text attach_btn"><i class="fas fa-paperclip"></i></span>
            </div>
            <textarea name="" id="streamWriter" style="width: 80%;" class="form-control type_msg"
               placeholder="Type your message..."></textarea>
            <div class="input-group-append">
               <span class="input-group-text send_btn"><i class="fas fa-location-arrow"></i></span>
            </div>
         </div>
      </div>
   </div>
</div>

<script>
  /////////////////////////
// insert HTML in js
function initRTC(id){
}



/////////////////////////
var socket = io.connect("http://18.183.81.183:9000/");

var nameRoom;
var nameRommCurrent;
var inforUser;


function getInforUser() {
let data;
let user;
var currentDate = new Date();
data = $.parseJSON($.ajax({
    url: 'http://ip-api.com/json/',
    dataType: "json",
    async: false
}).responseText);
user = {
    'country': data['country'],
    'city': data['city'],
    'timezone': data['timezone'],
    'ip': data['query'],
    'created_at': currentDate,
}
return user;
}

socket.on('connect', async function() {
let inforUser = await getInforUser();
if (sessionStorage.getItem('nameGroup')) {
    inforUser['nameGroup'] = sessionStorage.getItem('nameGroup')
}
if (sessionStorage.getItem('userID')) {
    inforUser['userID'] = sessionStorage.getItem('userID')
}
socket.emit('them_thanh_vien', 'userchat', inforUser);
});


socket.on('thong_bao', function(server, id, nameRooms) {
nameRoom = JSON.parse(nameRooms);
nameRommCurrent = nameRoom[id]['nameRoom'];
sessionStorage.setItem('nameGroup', nameRommCurrent);
sessionStorage.setItem('userID', id);
});

socket.on('my_message', function(object_message) {
let new_message = JSON.parse(object_message);
if (new_message.userID != 3) {
    nameRommCurrent = new_message.nameRoom
    var currentDate = new Date();
    var currentDatechat = currentDate.getHours() + ':' + currentDate.getMinutes();
    var ampm = currentDate.getHours() >= 12 ? 'PM' : 'AM';
    $('.msg_card_body').append(`<div class="d-flex justify-content-start mb-4"> <div class="img_cont_msg"> <img src="https://static.turbosquid.com/Preview/001292/481/WV/_D.jpg"  class="rounded-circle user_img_msg">  </div> <div class="msg_cotainer">  ${new_message.message} .<span class="msg_time">${currentDatechat} ${ampm},Today</span></div></div>`);
    $(".msg_card_body").stop().animate({
        scrollTop: $(".msg_card_body")[0].scrollHeight
    }, 1000);
}
})


$('textarea#streamWriter').keydown(function(e) {
if (e.keyCode === 13 && e.ctrlKey) {
    $(this).val(function(i, val) {
        return val + "\n";
    });
}
}).keypress(function(e) {
if (e.keyCode === 13 && !e.ctrlKey) {
    sendMessage();
    return false;
}
});

function sendMessage() {
let contentChat = $('textarea#streamWriter').val().trim();
var currentDate = new Date();
var currentDatechat = currentDate.getHours() + ':' + currentDate.getMinutes();
var ampm = currentDate.getHours() >= 12 ? 'PM' : 'AM';
if (contentChat) {
    $('.msg_card_body').append(`<div class="d-flex justify-content-end mb-4"><div class="msg_cotainer_send">${contentChat}<span class="msg_time_send">${currentDatechat},${ampm} </span></div><div class="img_cont_msg"><img src="https://static.turbosquid.com/Preview/001292/481/WV/_D.jpg" class="rounded-circle user_img_msg"></div></div>`);
    $(".msg_card_body").stop().animate({
        scrollTop: $(".msg_card_body")[0].scrollHeight
    }, 1000);
    $('textarea#streamWriter').val('');
    let newmessage = {
        nameRoom: nameRommCurrent,
        username: 'userchat',
        message: contentChat,
        userID: 3,
    }
    socket.emit('new_message', JSON.stringify(newmessage));
}
}
$('.input-group-append').click(function() {
sendMessage();
})

$('#longanit').click(function() {
$('.banner-noti-browser').fadeOut(500);
$('.icon-chat').fadeIn()
})



// cal video
var stream;
var yourConn;


$("#myBtn").click(function() {
$("#myModalCall").modal({
    backdrop: 'static',
    keyboard: false
});
$('#myModal').hide();
$('.icon-chat').fadeIn();
});

socket.on('new_call', function(object_new_call) {
new_call = JSON.parse(object_new_call);
// new_call = object_new_call;
if (new_call.userID != 3) {
    let anwser_calling = true;
    if (confirm('bạn có cuộc gọi từ tư vấn viên')) {
        $("#myModalCall").modal({
            backdrop: 'static',
            keyboard: false
        });
        $('#myModal').hide();
        $('.icon-chat').fadeIn();
        loadVideoLocal();
    } else {
        anwser_calling = true;
        $("#myModalCall").modal({
            backdrop: 'static',
            keyboard: false
        });
        $('#myModal').hide();
        $('.icon-chat').fadeIn();
        loadVideoLocal();
    }
    let anser_new_call = {
        nameRoom: new_call.nameRoom,
        calling: anwser_calling,
        action: new_call.action,
        userID: 3,
    }
    sendMessageCall(anser_new_call)
}
})




function sendMessageCall(object_mess) {
socket.emit(object_mess.action, JSON.stringify(object_mess));
// socket.emit(object_mess.action, object_mess);
}

function loadVideoLocal() {
if (hasUserMedia()) {
    var constraints = {
        video: true,
        audio: true,
    };
    navigator.webkitGetUserMedia(constraints, function(mediaStream) {
        stream = mediaStream;
        var video = document.querySelector('video#myVideo');
        var remoteVideo = document.querySelector('#videoOnline')
        var localAudio = document.querySelector('#localAudio');
        var remoteAudio = document.querySelector('#remoteAudio');
        video.srcObject = stream;
        localAudio.srcObject = stream;

        $('.toggle-video').css('background', '#00adff')

        var configuration = {
            'iceServers': [{
                    'url': 'stun:stun.l.google.com:19302'
                },
                {
                    'url': 'turn:192.158.29.39:3478?transport=udp',
                    'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
                    'username': '28224511:1379330808'
                },
                {
                    'url': 'turn:192.158.29.39:3478?transport=tcp',
                    'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
                    'username': '28224511:1379330808'
                }
            ]
        };

        yourConn = new webkitRTCPeerConnection(configuration);


        yourConn.addStream(stream)
        //when a remote user adds stream to the peer connection, we display it
        yourConn.onaddstream = function(event) {
            remoteVideo.srcObject = event.stream;
            remoteAudio.srcObject = event.stream;
        }

        // Setup ice handling
        yourConn.onicecandidate = function(event) {
            if (event.candidate) {
                sendMessageCall({
                    nameRoom: nameRommCurrent,
                    action: 'send_candidate',
                    userID: 3,
                    data: event.candidate,
                });
            }
            // ok   m phỉa chia event ở đoạn này đéo chơi switchcase nhé
        }


    }, function(error) {
        console.log(error);
    });
} else {
    alert("Rất xin lỗi bạn !. Trình duyệt chưa hỗ trợ");
}

}

function hasUserMedia() {
navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
    navigator.mozGetUserMedia || navigator.msGetUserMedia;
return !!navigator.getUserMedia;
}


$('.button-leave').click(function() {
remoteAudio.src = null;
stream.srcObject = null;
let tracks = stream.getTracks();
tracks.forEach(function(track) {
    track.stop();
});
stream = null;
yourConn.close();
yourConn.onicecandidate = null;
yourConn.onaddstream = null;
})

socket.on('send_offer', function(object_send_offer) {
send_offer = JSON.parse(object_send_offer);
// send_offer = object_send_offer;
if (send_offer.userID != 3) {
    handleOffer(send_offer.nameRoom, send_offer.data);
}
})

function handleOffer(nameRoom, offer) {
yourConn.setRemoteDescription(new RTCSessionDescription(offer));
yourConn.createAnswer(function(answer) {
    yourConn.setLocalDescription(answer);
    sendMessageCall({
        nameRoom: nameRoom,
        action: 'send_answer',
        userID: 3,
        data: answer,
    })
}, function(error) {
    alert("Error when creating an answer");
});
}

socket.on('send_candidate', function(object_send_candidate) {
send_candidate = JSON.parse(object_send_candidate);
// send_candidate = object_send_candidate;
if (send_candidate.userID != 3) {
    yourConn.addIceCandidate(new RTCIceCandidate(send_candidate.data));
}
})

function handleCandidate(candidate) {
yourConn.addIceCandidate(new RTCIceCandidate(candidate));
}



// $('.toggle-video').click(function () {
//    $('#myVideo')[0].srcObject = null;
//    $('.toggle-video').css('background', '#fffcfc')
// });

$('.button-share').click(function() {
var displayMediaStreamConstraints = {
   video: true,
   audio: true,
};
if (navigator.mediaDevices.getDisplayMedia) {
   navigator.mediaDevices.getDisplayMedia(displayMediaStreamConstraints)
      .then(function (mediaStream) {
         var video = document.querySelector('video#myVideo');
         video.srcObject = mediaStream;
         video.onloadedmetadata = function (e) {
            video.play();
         };
         $('.toggle-video').css('background', '#fffcfc')
      })
      .catch(function (err) { console.log(err.name + ": " + err.message); });
} else {
   navigator.getDisplayMedia(displayMediaStreamConstraints).then(success).catch(error);
}
});


var checkLoad = true;
$('.open-button').on('click', function(e) {
e.preventDefault();
var customer = {
    'name': $('.validate-input input[name="name"]').val().trim(),
    'email': $('.validate-input input[name="email"]').val().trim(),
};
for (let key in customer) {
    console.log(111, key)
    if (!customer[key] && key !== 'phone' && key !== 'content') {
        alert(key + ' không được để trống');
        return;
    }
    if (key == 'email') {
        if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(customer[key]) == false) {
            alert('Email không đúng định dạng');
            return;
        }
    }
}
sessionStorage.setItem('customer', JSON.stringify({
    name: customer['name'],
    email: customer['email'],
}));

$('.validate-form').hide();
$('#myModal').fadeIn(500);
$('.name_customer').text(customer['name'])
});


$('.button-chat').on('click', function() {
let userName = JSON.parse(sessionStorage.getItem('customer'));
$('.banner-noti-browser').hide();
if (!sessionStorage.getItem('customer')) {
    $('.validate-form').fadeIn(500);
} else {
    $('.name_customer').text(userName['nameUser'])
    $('#myModal').fadeIn(500);
    if (checkLoad) {
        addMessage();
        checkLoad = false;
    }
}
})
// Nếu click bên ngoài đối tượng container thì ẩn nó đi
$('.close').click(function(e) {
$('.validate-form').fadeOut(500);
$('.icon-chat').fadeIn(500);
})
$('#close').click(function() {
$('#myModal').hide();
$('.banner-noti-browser').fadeIn(500);
});
$('.icon-chat').click(function() {
$('.icon-chat').hide()
let userName = JSON.parse(sessionStorage.getItem('customer'));

if (!sessionStorage.getItem('customer')) {
    $('.validate-form').fadeIn(500);
} else {
    $('.name_customer').text(userName['name'])
    $('#myModal').fadeIn(500);
    if (checkLoad) {
        addMessage();
        checkLoad = false;
    }
}
})

$('.register-customer').on('click', function(e) {
e.preventDefault();
// dang ki tu van
let inforCustomer = getInforUser();
var customer = {
    'name': $('.validate-input input[name="name"]').val().trim(),
    'email': $('.validate-input input[name="email"]').val().trim(),
    'phone': $('.validate-input input[name="phone"]').val().trim(),
    'content': $('.validate-input input[name="content"]').val(),
    'address': inforCustomer['city'],
    'ip': inforCustomer['ip'],
};
for (let key in customer) {
    if (!customer[key] && key !== 'phone' && key !== 'content') {
        alert(key + ' không được để trống');
        return;
    }
    if (key == 'email') {
        if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(customer[key]) == false) {
            alert('Email không đúng định dạng');
            return;
        }
    }
}
// dang ki tu van
socket.emit('register_customer', JSON.stringify(customer));
alert('cảm ơn bạn đã đăng kí tư vấn dịch vụ của chúng tôi')
});

function addMessage() {
if (sessionStorage.getItem('nameGroup')) {
    socket.emit('get_message_zooms', sessionStorage.getItem('nameGroup'));
    socket.on('get_message_zoom', function(listMessage) {
        listMessages = JSON.parse(listMessage)
        listMessages.forEach(element => {
            if (element.user_id == 3) {
                $('.msg_card_body').append(`<div class="msg-chat d-flex justify-content-end mb-4"><div class="msg_cotainer_send">${element.content}<span class="msg_time_send">today </span></div><div class="img_cont_msg"><img src="https://static.turbosquid.com/Preview/001292/481/WV/_D.jpg" class="rounded-circle user_img_msg"></div></div>`);

            } else {
                $('.msg_card_body').append(`<div class="msg-chat d-flex justify-content-start mb-4"> <div class="img_cont_msg"> <img src="https://static.turbosquid.com/Preview/001292/481/WV/_D.jpg"  class="rounded-circle user_img_msg">  </div> <div class="msg_cotainer">  ${element.content} .<span class="msg_time">Today</span></div></div>`);
            }
        });
    })
}
}
</script>
